name: Release

on:
  release:
    types: [published]
  push:
    branches:
      - main

jobs:
  node-version:
    name: ⚙️ Variables Setup
    runs-on: ubuntu-latest
    outputs:
      node-version: ${{ steps.node_version.outputs.node-version }}
    steps:
      - uses: actions/checkout@v4
        with:
          sparse-checkout: |
            package.json
          sparse-checkout-cone-mode: false
          ref: ${{ github.ref }}

      - id: node_version
        run: |
          NODE_VERSION=$(node -p "require('./package.json').engines.node")
          echo "NODE_VERSION: ${NODE_VERSION}"
          echo "node-version=${NODE_VERSION}" >> $GITHUB_OUTPUT

  release-zip:
    needs: [node-version]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # add step that reads required meteor version from apps/meteor/.meteor/release

      # - name: Set up Meteor.js
      #   uses: meteorengineer/setup-meteor@v2
      #   with:
      #     meteor-release: '2.16' # Must be the same as in apps/meteor/.meteor/release

      - uses: ./.github/actions/meteor-build
        with:
          node-version: ${{ needs.node-version.outputs.node-version }}
          coverage: false

      - name: Restore build
        uses: actions/download-artifact@v4
        with:
          name: build
          path: /tmp/build

      # - name: Upload to release
      #   uses: svenstaro/upload-release-action@v2
      #   with:
      #     repo_token: ${{ secrets.GITHUB_TOKEN }}
      #     file: "/tmp/build/Rocket.Chat.tar.gz"
      #     asset_name: rocket.chat.${{ github.ref }}.tgz
      #     tag: ${{ github.ref }}
      #     overwrite: true