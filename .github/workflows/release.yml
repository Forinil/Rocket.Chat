name: Release

on:
  release:
    types: [published]
  push:
    branches:
      - main

jobs:
  tool-versions:
    name: ⚙️ Variables Setup
    runs-on: ubuntu-latest
    outputs:
      node-version: ${{ steps.node_version.outputs.node-version }}
      meteor-version: ${{ steps.meteor_version.outputs.meteor-version }}
    steps:
      - uses: actions/checkout@v4
        with:
          sparse-checkout: |
            package.json
            apps/meteor/.meteor/release
          sparse-checkout-cone-mode: false
          ref: ${{ github.ref }}

      - id: node_version
        run: |
          set -e
          NODE_VERSION=$(node -p "require('./package.json').engines.node")
          echo "NODE_VERSION: ${NODE_VERSION}"
          echo "node-version=${NODE_VERSION}" >> $GITHUB_OUTPUT
      
      - id: meteor_version
        run: |
          set -e
          IFS="@" read -ra METEOR_VERSION_ARRAY <<< $(cat apps/meteor/.meteor/release)
          METEOR_VERSION="${METEOR_VERSION_ARRAY[1]}"
          echo "METEOR_VERSION: ${METEOR_VERSION}"
          echo "meteor-version=${METEOR_VERSION}" >> $GITHUB_OUTPUT
  release-zip:
    name: 🚀 Release archive
    needs: [tool-versions]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Use Node.js ${{ needs.tool-versions.outputs.node-version }}
        id: node-version
        uses: actions/setup-node@v4.1.0
        with:
          node-version: ${{ needs.tool-versions.outputs.node-version }}
          # cache: 'yarn'

      - name: Enable corepack
        run: |
          set -e
          corepack enable

      - name: Show tool versions
        run: |
          set -e
          node --version
          npm --version
          yarn --version
          # meteor --version
          python --version

      - name: Dummy failing job
        run: exit 1

      # add step that reads required meteor version from apps/meteor/.meteor/release

      # - name: Set up Meteor.js
      #   uses: meteorengineer/setup-meteor@v2
      #   with:
      #     meteor-release: '2.16' # Must be the same as in apps/meteor/.meteor/release

      # - name: Upload to release
      #   uses: svenstaro/upload-release-action@v2
      #   with:
      #     repo_token: ${{ secrets.GITHUB_TOKEN }}
      #     file: "/tmp/build/Rocket.Chat.tar.gz"
      #     asset_name: rocket.chat.${{ github.ref }}.tgz
      #     tag: ${{ github.ref }}
      #     overwrite: true